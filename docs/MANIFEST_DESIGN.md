# xplat Manifest Design

## Overview

Each plat-* project has an `xplat.yaml` manifest that declares everything xplat needs to:
1. Install the binary
2. Run it as a process
3. Configure environment
4. Include its taskfile

## Manifest Location

```
plat-mailerlite/
├── xplat.yaml          # Package manifest
├── Taskfile.yml        # Task definitions
├── cmd/mailerlite/     # Binary source
└── ...
```

## Schema

```yaml
# xplat.yaml - Package manifest for xplat ecosystem
apiVersion: xplat/v1
kind: Package

# Package identity
name: mailerlite
version: v0.1.0
description: MailerLite API client and webhook server
author: Gerard Webb
license: MIT

# Binary distribution
binary:
  # Name of the binary (what gets installed to PATH)
  name: mailerlite

  # How to install (pick one)
  source:
    # Option 1: Go install (most common for plat-* repos)
    go: github.com/joeblew999/plat-mailerlite/cmd/mailerlite

    # Option 2: GitHub release
    # github:
    #   repo: joeblew999/plat-mailerlite
    #   asset: mailerlite-{{.OS}}-{{.ARCH}}

    # Option 3: npm (for JS tools)
    # npm: mailerlite-cli

    # Option 4: URL (direct download)
    # url: https://example.com/mailerlite-{{.OS}}-{{.ARCH}}

# Taskfile for remote include
taskfile:
  # Path within the repo
  path: Taskfile.yml

  # Namespace when included (defaults to package name)
  namespace: mailerlite

# Process configuration (for process-compose)
process:
  # Command to run the service
  command: mailerlite server

  # HTTP port for the service
  port: 8086

  # Health check endpoint
  health_path: /health

  # Readiness probe settings
  readiness:
    initial_delay: 5
    period: 10
    timeout: 5
    failure_threshold: 3

  # Process dependencies (start after these)
  depends_on:
    - pocketbase

  # Process group/namespace
  namespace: servers

  # Disabled by default (manual start)
  disabled: false

# Environment variables
env:
  # Required variables (process won't start without these)
  required:
    - name: MAILERLITE_API_KEY
      description: API key from MailerLite dashboard

  # Optional variables with defaults
  optional:
    - name: MAILERLITE_PORT
      description: Server port
      default: "8086"

    - name: MAILERLITE_LOG_LEVEL
      description: Logging verbosity
      default: "info"

# Dependencies on other packages
dependencies:
  # Runtime dependencies (must be running)
  runtime:
    - pocketbase

  # Build dependencies (must be installed)
  build:
    - go
```

## Minimal Example

```yaml
# Smallest valid manifest
apiVersion: xplat/v1
kind: Package
name: dummy
version: v0.1.0
binary:
  name: dummy
  source:
    go: github.com/joeblew999/plat-dummy/cmd/dummy
```

## Complex Example

```yaml
apiVersion: xplat/v1
kind: Package
name: google
version: v0.1.0
description: Google Workspace CLI

binary:
  name: google
  source:
    go: github.com/joeblew999/plat-google/cmd/google

taskfile:
  path: Taskfile.yml
  namespace: google

process:
  command: google gmail server
  port: 8087
  health_path: /health
  depends_on:
    - pocketbase
    - nats
  namespace: servers
  disabled: true  # Start manually

env:
  required:
    - name: GOOGLE_CLIENT_ID
      description: OAuth client ID from Google Cloud Console
    - name: GOOGLE_CLIENT_SECRET
      description: OAuth client secret
  optional:
    - name: GOOGLE_TOKEN_PATH
      description: Path to store OAuth tokens
      default: ~/.config/google/token.json

dependencies:
  runtime:
    - pocketbase
    - nats
```

## xplat Commands

```bash
# Discover and list all packages
xplat registry list

# Install a package binary
xplat pkg install mailerlite

# Install all dependencies for current project
xplat pkg install

# Generate files from manifests
xplat docs env          # → .env.example
xplat docs process      # → process-compose.generated.yaml
xplat docs taskfile     # → Taskfile.generated.yml (with includes)

# Validate manifest
xplat manifest validate

# Show what a package needs
xplat pkg info mailerlite
```

## Discovery Modes

### 1. Local Mode
Scan for `xplat.yaml` in known locations:
```
~/workspace/go/src/github.com/joeblew999/plat-*/xplat.yaml
```

### 2. Remote Mode
Fetch from GitHub repos:
```
https://raw.githubusercontent.com/joeblew999/plat-mailerlite/main/xplat.yaml
```

### 3. Registry Mode (hybrid)
Central registry points to repos, xplat fetches manifests on demand:
```yaml
# registry.yaml
packages:
  mailerlite: github.com/joeblew999/plat-mailerlite
  google: github.com/joeblew999/plat-google
```

## Generated Files

### .env.example
```bash
# Generated by: xplat docs env
# Source: plat-mailerlite/xplat.yaml, plat-google/xplat.yaml

# === mailerlite ===
# API key from MailerLite dashboard (required)
MAILERLITE_API_KEY=
# Server port (default: 8086)
# MAILERLITE_PORT=8086

# === google ===
# OAuth client ID from Google Cloud Console (required)
GOOGLE_CLIENT_ID=
# OAuth client secret (required)
GOOGLE_CLIENT_SECRET=
```

### process-compose.generated.yaml
```yaml
# Generated by: xplat docs process
version: "0.5"
processes:
  mailerlite:
    command: mailerlite server
    readiness_probe:
      http_get:
        path: /health
        port: 8086
      initial_delay_seconds: 5
    depends_on:
      pocketbase:
        condition: process_healthy

  google:
    command: google gmail server
    disabled: true
    # ...
```

### Taskfile.generated.yml
```yaml
# Generated by: xplat docs taskfile
version: "3"
includes:
  mailerlite:
    taskfile: https://github.com/joeblew999/plat-mailerlite.git//Taskfile.yml
  google:
    taskfile: https://github.com/joeblew999/plat-google.git//Taskfile.yml
```

## Migration Path

1. Create `xplat.yaml` in each plat-* repo
2. Update xplat to parse manifests
3. Remove Hugo registry generation
4. Hugo website can still display packages (fetch manifests from GitHub)
