# ============================================================================
# xplat Development Taskfile
# ============================================================================
# This is xplat's own development Taskfile, NOT auto-generated.
# For user projects, 'xplat manifest bootstrap' generates Taskfile.yml.
#
# Binary naming convention is defined in:
#   cmd/xplat/cmd/release.go -> binaryFilename()
#   Pattern: {name}-{os}-{arch}{.exe}
# ============================================================================

version: "3"

dotenv: ['.env']

vars:
  # xplat binary - all commands go through xplat for cross-platform support
  XPLAT: xplat

  # Binary configuration
  BINARY: xplat
  MAIN: .

env:
  GOWORK: off

tasks:
  default:
    desc: Show available tasks
    silent: true
    cmds:
      - |
        echo ""
        echo "xplat - Cross-platform development toolkit"
        echo ""
        echo "Development:"
        echo "  dev:build    Build xplat binary with code generation"
        echo "  dev:run      Build and run xplat"
        echo "  dev:test     Run tests"
        echo "  dev:lint     Run linter"
        echo "  dev:mod      Tidy Go modules"
        echo "  dev:clean    Remove build artifacts"
        echo ""
        echo "Release (CI):"
        echo "  release:build       Build for current platform"
        echo "  release:build:all   Build for all platforms"
        echo "  release:list        Show built releases"
        echo "  release:clean       Remove release artifacts"
        echo ""

  # ===========================================================================
  # dev: - Development commands
  # ===========================================================================

  dev:build:
    desc: Build xplat binary with code generation
    deps: [_ensure-xplat]
    cmds:
      - './xplat internal dev build'

  dev:clean:
    desc: Remove build artifacts
    cmds:
      - rm -f {{ .BINARY }}

  dev:lint:
    desc: Run linter
    cmds:
      - golangci-lint run || echo "golangci-lint not installed, skipping"

  dev:mod:
    desc: Tidy Go modules
    cmds:
      - go mod tidy

  dev:run:
    desc: Build and run xplat
    deps: [dev:build]
    cmds:
      - '{{.XPLAT}}'

  dev:test:
    desc: Run tests
    cmds:
      - echo "No tests yet"

  # ===========================================================================
  # release: - Release commands (uses xplat release build for SSOT naming)
  # ===========================================================================
  # Binary naming is controlled by binaryFilename() in cmd/xplat/cmd/release.go
  # Pattern: {name}-{os}-{arch}{.exe}
  #
  # Note: Uses ./xplat (local binary) to avoid PATH issues during development.
  # CI uses xplat release build directly after bootstrap.

  release:build:
    desc: Build for current platform
    deps: [_ensure-xplat]
    cmds:
      - './xplat release build xplat --current'

  release:build:all:
    desc: Build for all platforms
    deps: [_ensure-xplat]
    cmds:
      - './xplat release build xplat'

  release:clean:
    desc: Remove release artifacts
    cmds:
      - rm -rf .releases

  release:list:
    desc: Show built releases
    deps: [_ensure-xplat]
    cmds:
      - './xplat release list xplat --dir .releases'

  _ensure-xplat:
    desc: Ensure local xplat binary exists
    internal: true
    status:
      - test -f ./xplat
    cmds:
      - go build -o xplat .
