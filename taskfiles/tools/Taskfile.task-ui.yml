# Task-UI Tasks
#
# Web-based dashboard for executing Taskfile tasks.
# Uses xplat binary:install for cross-platform binary management.
#
# Usage:
#   task tui:up             Start Task-UI at http://localhost:3000
#   task tui:down           Stop Task-UI (Ctrl+C)
#   task tui:status         Not running as daemon
#
# Documentation: https://github.com/titpetric/task-ui
#
# REQUIRES: xplat (for binary management)

version: '3'

vars:
  # Version from xplat.env (loaded by root Taskfile dotenv)
  TUI_VERSION: '{{.TASK_UI_VERSION}}'
  TUI_REPO: joeblew999/ubuntu-website
  TUI_BIN: 'task-ui{{exeExt}}'
  TUI_CGO: '0'  # No CGO needed
  TUI_CMD: '{{.BIN_INSTALL_DIR}}/{{.TUI_BIN}}'
  TUI_PORT: '3000'

tasks:
  # ===========================================================================
  # Checks (check:* - lifecycle phase)
  # ===========================================================================

  check:deps:
    desc: Ensure task-ui binary is available (builds from source or downloads)
    internal: true
    status:
      - test -f "{{.BIN_INSTALL_DIR}}/{{.TUI_BIN}}"
    cmds:
      - task: :tools:xplat:binary:install
        vars:
          CLI_ARGS: 'task-ui {{.TASK_UI_VERSION}} {{.TUI_REPO}} --source "{{toSlash .ROOT_DIR}}/cmd/task-ui"'

  # ===========================================================================
  # Core Commands (up/down)
  # ===========================================================================

  up:
    desc: Start Task-UI web dashboard at http://localhost:3000
    deps: [check:deps]
    cmds:
      - 'echo "Starting Task-UI at http://localhost:{{.TUI_PORT}}"'
      - 'echo "Press Ctrl+C to stop"'
      - 'echo ""'
      - '{{.TUI_CMD}} --history-enable'

  # ===========================================================================
  # Release (release:* - build for distribution)
  # ===========================================================================

  release:build:
    desc: Build task-ui for release (current platform, or set GOOS/GOARCH)
    cmds:
      - task: :toolchain:golang:build
        vars:
          BIN: '{{.TUI_BIN}}'
          VERSION: '{{.RELEASE_VERSION | default .TASK_UI_VERSION}}'
          SOURCE: '{{.ROOT_DIR}}/cmd/task-ui'
          CGO: '{{.TUI_CGO}}'

  release:test:
    desc: Test built task-ui release binary
    cmds:
      - task: :toolchain:golang:build:test
        vars:
          BIN: '{{.TUI_BIN}}'

  release:publish:
    desc: Build all platforms and create GitHub release
    requires:
      vars: [VERSION]
    cmds:
      - task: :tools:xplat:release:build
        vars:
          CLI_ARGS: 'tui'
      - task: :tools:gh:release:publish
        vars:
          NAME: 'task-ui'
          VERSION: '{{.VERSION}}'
