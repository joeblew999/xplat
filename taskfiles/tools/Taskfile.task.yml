# Task - go-task/task Taskfile Runner
#
# Provides version checking to ensure local and CI use the same Task version.
# This prevents subtle behavior differences between environments.
#
# Usage:
#   task tools:task:check:deps   - Verify Task version matches expected
#
# Pattern: All tool taskfiles define TOOL_BIN with {{exeExt}} for Windows support
# Version: Reads TASK_VERSION from root xplat.env (loaded by root Taskfile)

version: '3'

vars:
  # Archetype: external - we install go-task from go-task/task, we don't build it
  XPLAT_ARCHETYPE: external
  # TASK_VERSION comes from xplat.env (loaded by root Taskfile dotenv)
  TASK_VERSION: '{{.TASK_VERSION}}'
  # Binary name with platform-specific extension (.exe on Windows)
  TASK_BIN: 'task{{exeExt}}'

tasks:
  # ===========================================================================
  # Checks (check:* - diagnostics for this module)
  # ===========================================================================

  check:deps:
    desc: Verify Task version matches expected (warns on mismatch)
    run: once
    cmds:
      - |
        # TASK_VERSION comes from xplat.env (loaded by root Taskfile dotenv)
        EXPECTED="${TASK_VERSION:-3.45.5}"

        # Get installed version
        INSTALLED=$({{.TASK_BIN}} --version 2>/dev/null | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' | head -1)

        if [ -z "$INSTALLED" ]; then
          echo "ERROR: task not found in PATH"
          echo "Install from: https://taskfile.dev/installation/"
          exit 1
        fi

        if [ "$INSTALLED" != "$EXPECTED" ]; then
          echo "WARN: Task version mismatch"
          echo "  Expected: $EXPECTED"
          echo "  Installed: $INSTALLED"
          echo ""
          echo "Update with: brew upgrade go-task (macOS)"
          echo "  or: go install github.com/go-task/task/v3/cmd/task@v$EXPECTED"
          echo ""
          echo "Note: CI uses $EXPECTED - version mismatch may cause issues"
        else
          echo "OK: task $INSTALLED"
        fi
