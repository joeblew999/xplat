# Bun Runtime Tasks
#
# Cross-platform Bun installation and validation.
# Works on macOS, Linux, Windows.
#
# Version Management:
#   - BUN_VERSION from xplat.env (loaded by root Taskfile dotenv)
#
# Pattern: All tool taskfiles define TOOL_BIN with {{exeExt}} for Windows support
#
# Other modules that need Bun should:
#   1. Add `# REQUIRES: bun` to their header
#   2. Call `task: :bun:check:deps` before using Bun

version: '3'

# REQUIRES: none

vars:
  # Archetype: builder - Bun is a compiler/runtime toolchain
  XPLAT_ARCHETYPE: builder
  # BUN_VERSION comes from xplat.env (loaded by root Taskfile dotenv)
  BUN_VERSION: '{{.BUN_VERSION}}'
  BUN_BIN: 'bun{{exeExt}}'

tasks:
  # ===========================================================================
  # Checks (check:* - diagnostics for this module)
  # ===========================================================================

  check:deps:
    desc: Check if Bun is installed (informational - does not fail)
    run: once
    cmds:
      - |
        # BUN_VERSION comes from xplat.env (loaded by root Taskfile dotenv)
        EXPECTED="${BUN_VERSION:-1.3}"

        # Check if bun exists
        if ! command -v bun >/dev/null 2>&1; then
          echo "INFO: Bun not installed (optional toolchain)"
          echo ""
          echo "Install options:"
          echo "  1. Official: curl -fsSL https://bun.sh/install | bash"
          echo "  2. macOS: brew install oven-sh/bun/bun"
          echo "  3. Windows: powershell -c \"irm bun.sh/install.ps1 | iex\""
          echo "  4. CI: uses: oven-sh/setup-bun@v2"
          exit 0  # Don't fail - bun is optional
        fi

        # Get installed version (e.g., "1.3" from "1.3.3")
        INSTALLED=$(bun --version | cut -d. -f1,2)

        if [ "$INSTALLED" = "$EXPECTED" ]; then
          echo "OK: bun $(bun --version) (matches expected $EXPECTED.x)"
          exit 0
        fi

        # Version mismatch - just warn for bun (unlike Go, bun versions are generally compatible)
        echo "WARN: Bun version mismatch"
        echo "  Expected: $EXPECTED.x (from xplat.env)"
        echo "  Installed: $(bun --version)"
        echo ""
        echo "This is usually fine - bun versions are generally compatible."

  check:require:
    desc: Require Bun (fails if not installed - for workflows that need it)
    cmds:
      - |
        EXPECTED="${BUN_VERSION:-1.3}"

        if ! command -v bun >/dev/null 2>&1; then
          echo "ERROR: Bun is required but not installed"
          echo ""
          if [ -n "$CI" ] || [ -n "$GITHUB_ACTIONS" ]; then
            echo "Add to your workflow:"
            echo "    - uses: oven-sh/setup-bun@v2"
            echo "      with:"
            echo "        bun-version: '$EXPECTED'"
          else
            echo "Install: curl -fsSL https://bun.sh/install | bash"
          fi
          exit 1
        fi
        echo "OK: bun $(bun --version)"

  check:validate:
    desc: Smoke test Bun works (skips if not installed)
    cmds:
      - |
        if ! command -v bun >/dev/null 2>&1; then
          echo "SKIP: bun not installed"
          exit 0
        fi
        echo "Validating Bun..."
        bun --version
        echo "bun:check:validate passed"

  check:health:
    desc: Check npm registry is reachable (skips if not installed)
    cmds:
      - |
        if ! command -v bun >/dev/null 2>&1; then
          echo "SKIP: bun not installed"
          exit 0
        fi
        echo "Checking npm registry..."
        # Simple connectivity check - ping registry
        if bun pm ls 2>/dev/null | head -1 >/dev/null; then
          echo "npm registry reachable"
        fi
        echo "bun:check:health passed"

  # ===========================================================================
  # Build (build:* - compile binaries using Bun)
  # ===========================================================================

  build:
    desc: Build a Bun project (requires BIN, SOURCE vars)
    deps: [check:require]
    requires:
      vars: [BIN, SOURCE]
    cmds:
      - |
        echo "Building {{.BIN}} from {{.SOURCE}}..."
        cd "{{.SOURCE}}"
        bun build ./index.ts --compile --outfile "{{.BIN}}"
        echo "OK: Built {{.BIN}}"
