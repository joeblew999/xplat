# Dummy tool for testing release workflows quickly
# Minimal binary - just prints version
#
# Full round-trip test:
#   1. task dummy:release:publish VERSION=v0.0.1  # Build all platforms, publish to GitHub
#   2. rm ~/.local/bin/dummy                      # Remove local binary
#   3. task dummy:check:deps                      # Downloads from GitHub release
#   4. task dummy:run                             # Should print v0.0.1
#
version: '3'

vars:
  DUMMY_VERSION: v0.0.1
  DUMMY_REPO: joeblew999/ubuntu-website
  DUMMY_BIN: 'dummy{{exeExt}}'
  DUMMY_CGO: '0'
  XPLAT_AFFINITY: cross  # Can cross-compile from any platform

tasks:
  # ===========================================================================
  # Check (downloads from release if missing)
  # ===========================================================================

  check:deps:
    desc: Ensure dummy binary is available (builds from source or downloads)
    status:
      - test -f "{{.BIN_INSTALL_DIR}}/{{.DUMMY_BIN}}"
    cmds:
      - task: :tools:xplat:binary:install
        vars:
          CLI_ARGS: 'dummy {{.DUMMY_VERSION}} {{.DUMMY_REPO}} --source "{{toSlash .ROOT_DIR}}/cmd/dummy"'

  check:validate:
    desc: Verify dummy works
    deps: [check:deps]
    cmds:
      - '"{{.BIN_INSTALL_DIR}}/{{.DUMMY_BIN}}"'

  # ===========================================================================
  # Run
  # ===========================================================================

  run:
    desc: Run the dummy binary
    deps: [check:deps]
    cmds:
      - '"{{.BIN_INSTALL_DIR}}/{{.DUMMY_BIN}}"'

  # ===========================================================================
  # Build (local development)
  # ===========================================================================

  build:
    desc: Build dummy binary locally
    cmds:
      - task: :toolchain:golang:build
        vars:
          BIN: '{{.DUMMY_BIN}}'
          VERSION: dev
          SOURCE: '{{.ROOT_DIR}}/cmd/dummy'
          CGO: '{{.DUMMY_CGO}}'

  # ===========================================================================
  # Release
  # ===========================================================================

  release:build:
    desc: Build dummy for release (current platform, or set GOOS/GOARCH)
    cmds:
      - task: :toolchain:golang:build
        vars:
          BIN: '{{.DUMMY_BIN}}'
          VERSION: '{{.RELEASE_VERSION | default .DUMMY_VERSION}}'
          SOURCE: '{{.ROOT_DIR}}/cmd/dummy'
          CGO: '{{.DUMMY_CGO}}'

  release:test:
    desc: Test built dummy binary
    cmds:
      - task: :toolchain:golang:build:test
        vars:
          BIN: '{{.DUMMY_BIN}}'

  release:verify:
    desc: Verify all platform binaries were built
    cmds:
      - |
        echo "Verifying binaries..."
        COUNT=$({{.XPLAT_BIN}} release list dummy | wc -l | tr -d ' ')
        if [ "$COUNT" -ne 6 ]; then
          echo "ERROR: Expected 6 binaries, found $COUNT"
          {{.XPLAT_BIN}} release list dummy
          exit 1
        fi
        echo "OK: All 6 platform binaries built"
        {{.XPLAT_BIN}} release list dummy

  release:create:
    desc: Create GitHub release with all binaries
    requires:
      vars: [VERSION]
    cmds:
      - cmd: gh release delete "dummy-{{.VERSION}}" --yes --cleanup-tag 2>/dev/null || true
      - task: :tools:gh:release:publish
        vars:
          NAME: 'dummy'
          VERSION: '{{.VERSION}}'

  release:publish:
    desc: Build all platforms and create GitHub release
    requires:
      vars: [VERSION]
    cmds:
      - task: :tools:xplat:release:build
        vars:
          CLI_ARGS: 'dummy'
      - task: :tools:gh:release:publish
        vars:
          NAME: 'dummy'
          VERSION: '{{.VERSION}}'

  release:verify-assets:
    desc: Verify GitHub release has all expected assets
    requires:
      vars: [VERSION]
    cmds:
      - |
        TAG="dummy-{{.VERSION}}"
        echo "Checking release: $TAG"

        # Get list of expected binaries
        EXPECTED=$({{.XPLAT_BIN}} release list dummy | wc -l | tr -d ' ')

        # Get list of actual assets in release
        ACTUAL=$(gh release view "$TAG" --json assets -q '.assets | length')

        if [ "$ACTUAL" -ne "$EXPECTED" ]; then
          echo "ERROR: Expected $EXPECTED assets, found $ACTUAL"
          echo ""
          echo "Expected binaries:"
          {{.XPLAT_BIN}} release list dummy
          echo ""
          echo "Actual release assets:"
          gh release view "$TAG" --json assets -q '.assets[].name'
          exit 1
        fi

        echo "OK: Release has $ACTUAL assets (expected $EXPECTED)"
        gh release view "$TAG" --json assets -q '.assets[].name'

  release:verify-download:
    desc: Download and verify binary from GitHub release
    requires:
      vars: [VERSION]
    cmds:
      - |
        TAG="dummy-{{.VERSION}}"
        # Use xplat to get the binary name for current platform
        BINARY=$({{.XPLAT_BIN}} release binary-name dummy)
        URL="https://github.com/{{.DUMMY_REPO}}/releases/download/$TAG/$BINARY"

        echo "Downloading: $URL"
        curl -sL "$URL" -o /tmp/dummy-download-test
        chmod +x /tmp/dummy-download-test

        # Verify it runs and outputs expected version
        OUTPUT=$(/tmp/dummy-download-test 2>&1)
        echo "Output: $OUTPUT"
        echo "Expected: {{.VERSION}}"

        if [ "$OUTPUT" != "{{.VERSION}}" ]; then
          echo "ERROR: Version mismatch!"
          echo "  Expected: {{.VERSION}}"
          echo "  Got: $OUTPUT"
          rm /tmp/dummy-download-test
          exit 1
        fi

        rm /tmp/dummy-download-test
        echo "OK: Downloaded binary works and version matches"

  release:cleanup:
    desc: Delete test release
    requires:
      vars: [VERSION]
    cmds:
      - |
        TAG="dummy-{{.VERSION}}"
        echo "Deleting test release $TAG"
        gh release delete "$TAG" --yes --cleanup-tag 2>/dev/null || true

  # ===========================================================================
  # CI Test (full round-trip - same locally and in CI)
  # ===========================================================================

  ci:test:
    desc: Full round-trip test (same locally and in CI)
    vars:
      # Use VERSION if provided, otherwise generate timestamp-based version
      TEST_VERSION: '{{.VERSION | default (printf "v0.0.0-test-%s" (now | date "20060102-150405"))}}'
      # Set SKIP_CLEANUP=true to skip cleanup (for CI multi-platform verify)
      DO_CLEANUP: '{{if .SKIP_CLEANUP}}false{{else}}true{{end}}'
    cmds:
      - |
        echo "=== Dummy CI Test ==="
        echo "Version: {{.TEST_VERSION}}"
        echo "Skip cleanup: {{if eq .DO_CLEANUP "true"}}no{{else}}yes{{end}}"
        echo ""

      # Phase 1: Build Validation
      - 'echo "=== Phase 1: Build Validation ==="'
      - task: build
      - task: release:build
      - task: release:test
      - task: run

      # Phase 2: Cross-compile all platforms
      - 'echo "=== Phase 2: Cross-compile All Platforms ==="'
      - 'RELEASE_VERSION={{.TEST_VERSION}} {{.XPLAT_BIN}} release build dummy'

      # Phase 3: Verify binaries in .build/
      - 'echo "=== Phase 3: Verify Binaries ==="'
      - task: release:verify

      # Phase 4: Create GitHub release
      - 'echo "=== Phase 4: Create GitHub Release ==="'
      - task: release:create
        vars: { VERSION: '{{.TEST_VERSION}}' }

      # Phase 5: Verify release assets on GitHub
      - 'echo "=== Phase 5: Verify Release Assets ==="'
      - task: release:verify-assets
        vars: { VERSION: '{{.TEST_VERSION}}' }

      # Phase 6: Download and verify binary works
      - 'echo "=== Phase 6: Verify Download ==="'
      - task: release:verify-download
        vars: { VERSION: '{{.TEST_VERSION}}' }

      # Phase 7: Cleanup test release (skip if SKIP_CLEANUP=true)
      - |
        if [ "{{.DO_CLEANUP}}" = "true" ]; then
          echo "=== Phase 7: Cleanup ==="
        else
          echo "=== Phase 7: Cleanup (SKIPPED) ==="
          exit 0
        fi
      - task: release:cleanup
        vars: { VERSION: '{{.TEST_VERSION}}' }

      - 'echo ""'
      - 'echo "=== PASS: Full round-trip test completed ==="'

  ci:verify-download:
    desc: Verify download from GitHub (for CI multi-platform jobs)
    requires:
      vars: [VERSION]
    cmds:
      - task: release:verify-download
        vars: { VERSION: '{{.VERSION}}' }
