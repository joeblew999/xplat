# {{.Name}} Taskfile
#
# Generated by: xplat gen taskfile
# Regenerate with: xplat gen taskfile
#
# Run 'task' to see available commands

version: "3"

vars:
  BINARY: {{.Binary}}
  MAIN: {{.MainPath}}

tasks:
  default:
    desc: Show available tasks
    cmds:
      - task --list

  build:
    desc: Build the binary
    cmds:
      - go build -o {{"{{"}} .BINARY {{"}}"}} {{"{{"}} .MAIN {{"}}"}}

  test:
    desc: Run tests
    cmds:
{{if .HasTests}}      - go test ./...
{{else}}      - echo "No tests yet"
{{end}}
  lint:
    desc: Run linter
    cmds:
      - golangci-lint run || echo "golangci-lint not installed, skipping"

  clean:
    desc: Clean build artifacts
    cmds:
      - rm -f {{"{{"}} .BINARY {{"}}"}}

  install:
    desc: Install to GOBIN
    cmds:
      - go install {{"{{"}} .MAIN {{"}}"}}

  run:
    desc: Build and run
    deps: [build]
    cmds:
      - ./{{"{{"}} .BINARY {{"}}"}}

  mod:
    desc: Tidy go modules
    cmds:
      - go mod tidy

  # ===========================================================================
  # Release Commands (called by CI on tags)
  # ===========================================================================

  release:build:
    desc: Build release binaries for all platforms
    cmds:
      - mkdir -p .releases
{{if eq .Language "go"}}      - GOOS=linux GOARCH=amd64 go build -o .releases/{{ "{{" }} .BINARY {{ "}}" }}-linux-amd64 {{ "{{" }} .MAIN {{ "}}" }}
      - GOOS=linux GOARCH=arm64 go build -o .releases/{{ "{{" }} .BINARY {{ "}}" }}-linux-arm64 {{ "{{" }} .MAIN {{ "}}" }}
      - GOOS=darwin GOARCH=amd64 go build -o .releases/{{ "{{" }} .BINARY {{ "}}" }}-darwin-amd64 {{ "{{" }} .MAIN {{ "}}" }}
      - GOOS=darwin GOARCH=arm64 go build -o .releases/{{ "{{" }} .BINARY {{ "}}" }}-darwin-arm64 {{ "{{" }} .MAIN {{ "}}" }}
      - GOOS=windows GOARCH=amd64 go build -o .releases/{{ "{{" }} .BINARY {{ "}}" }}-windows-amd64.exe {{ "{{" }} .MAIN {{ "}}" }}
{{else if eq .Language "rust"}}      - cargo build --release --target x86_64-unknown-linux-gnu
      - cargo build --release --target aarch64-unknown-linux-gnu
      - cargo build --release --target x86_64-apple-darwin
      - cargo build --release --target aarch64-apple-darwin
      - cargo build --release --target x86_64-pc-windows-msvc
{{end}}
