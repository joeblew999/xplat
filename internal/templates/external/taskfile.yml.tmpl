# ============================================================================
# GENERATED FILE - DO NOT EDIT MANUALLY
# ============================================================================
# Generated by: xplat manifest bootstrap
# Regenerate with: xplat manifest bootstrap --force
# Source: https://github.com/joeblew999/xplat
# ============================================================================
#
# {{.Name}} Taskfile - Run 'xplat task' to see available commands
#
# xplat file structure:
#   xplat.yaml              - Package manifest (defines binary, processes, env)
#   Taskfile.yml            - THIS FILE: all build/run/service tasks
#   taskfiles/Taskfile.service.yml - Generated reusable tasks for pkg consumers
#   process-compose.yaml    - Process orchestration (uses xplat task commands)
{{if .IsExternalRepo}}#
# xplat directory convention (external repo):
#   .src/   - cloned source repositories
#   .bin/   - built binaries
#   .data/  - runtime data
{{end}}
version: "3"

dotenv: ['.env']

vars:
  # xplat binary - all commands go through xplat for cross-platform support
  XPLAT: xplat

  # Binary configuration
  BINARY: {{.Binary}}
{{if .IsExternalRepo}}  BINARY_FILE: '{{.Binary}}{{ "{{" }}exeExt{{ "}}" }}'
  VERSION: '{{.SourceVersion}}'
  UPSTREAM: '{{.SourceRepo}}'

  # xplat directory convention
  SRC_DIR: '{{ "{{" }}.ROOT_DIR{{ "}}" }}/.src/{{.Binary}}'
  BIN_DIR: '{{ "{{" }}.ROOT_DIR{{ "}}" }}/.bin'
  BIN_PATH: '{{ "{{" }}.BIN_DIR{{ "}}" }}/{{ "{{" }}.BINARY_FILE{{ "}}" }}'
  DATA_DIR: '{{ "{{" }}.ROOT_DIR{{ "}}" }}/.data'
{{else}}  MAIN: {{.MainPath}}
{{end}}
env:
  GOWORK: off

tasks:
  default:
    desc: Show available tasks
    cmds:
      - '{{ "{{" }}.XPLAT{{ "}}" }} task --list'

{{if .IsExternalRepo}}  # ===========================================================================
  # Setup - First time initialization
  # ===========================================================================

  setup:
    desc: First time setup - clone and build {{.Binary}}
    cmds:
      - task: src:clone
      - task: bin:build

  # ===========================================================================
  # Source Management - Clone/update upstream repository
  # ===========================================================================

  src:clone:
    desc: Clone {{.Binary}} repository at pinned version
    run: once
    cmds:
      - '{{ "{{" }}.XPLAT{{ "}}" }} os mkdir -p {{ "{{" }}.ROOT_DIR{{ "}}" }}/.src'
      - git clone --depth 1 --branch {{ "{{" }}.VERSION{{ "}}" }} {{ "{{" }}.UPSTREAM{{ "}}" }} {{ "{{" }}.SRC_DIR{{ "}}" }}
    status:
      - git -C {{ "{{" }}.SRC_DIR{{ "}}" }} rev-parse HEAD

  src:update:
    desc: Fetch and checkout pinned version
    deps: [src:clone]
    dir: '{{ "{{" }}.SRC_DIR{{ "}}" }}'
    cmds:
      - git fetch --tags
      - git checkout {{ "{{" }}.VERSION{{ "}}" }}

  # ===========================================================================
  # Binary Build - Compile from source
  # ===========================================================================

  bin:build:
    desc: Build {{.Binary}} binary from source
    deps: [src:clone]
    dir: '{{ "{{" }}.SRC_DIR{{ "}}" }}'
    cmds:
      - '{{ "{{" }}.XPLAT{{ "}}" }} os mkdir -p {{ "{{" }}.BIN_DIR{{ "}}" }}'
{{if eq .Language "go"}}      - go build -o {{ "{{" }}.BIN_PATH{{ "}}" }} {{.MainPath}}
{{else if eq .Language "rust"}}      - cargo build --release
      - cp target/release/{{ "{{" }}.BINARY_FILE{{ "}}" }} {{ "{{" }}.BIN_PATH{{ "}}" }}
{{end}}      - |
        # Create version file for tracking
        VERSION=$(git describe --tags --always 2>/dev/null || echo "{{ "{{" }}.VERSION{{ "}}" }}")
        COMMIT=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
        cat > {{ "{{" }}.BIN_DIR{{ "}}" }}/.version << EOF
        version: $VERSION
        commit: $COMMIT
        built: $(date -u +%Y-%m-%dT%H:%M:%SZ)
        EOF
    status:
      - '{{ "{{" }}if eq OS "windows"{{ "}}" }}Test-Path "{{ "{{" }}.BIN_PATH{{ "}}" }}"{{ "{{" }}else{{ "}}" }}test -f "{{ "{{" }}.BIN_PATH{{ "}}" }}"{{ "{{" }}end{{ "}}" }}'

  ensure:
    desc: Ensure {{.Binary}} binary exists (build if needed)
    status:
      - '{{ "{{" }}if eq OS "windows"{{ "}}" }}Test-Path "{{ "{{" }}.BIN_PATH{{ "}}" }}"{{ "{{" }}else{{ "}}" }}test -f "{{ "{{" }}.BIN_PATH{{ "}}" }}"{{ "{{" }}end{{ "}}" }}'
    cmds:
      - task: bin:build

  # ===========================================================================
  # Run - Execute the binary
  # ===========================================================================

  run:
    desc: Run {{.Binary}}
    deps: [ensure]
    cmds:
      - '{{ "{{" }}.BIN_PATH{{ "}}" }}{{if .RunArgs}} {{.RunArgs}}{{end}}'

  # ===========================================================================
  # Process Compose Integration
  # These use the <binary>:run and <binary>:health naming convention
  # ===========================================================================

  {{.Binary}}:run:
    desc: Run {{.Binary}} (called by process-compose)
    deps: [ensure]
    cmds:
      - '{{ "{{" }}.BIN_PATH{{ "}}" }}{{if .ServiceRunArgs}} {{.ServiceRunArgs}}{{else if .RunArgs}} {{.RunArgs}}{{end}}'

  {{.Binary}}:health:
    desc: Health check for {{.Binary}} (called by process-compose readiness probe)
    cmds:
      - curl -sf http://localhost:8080/ > /dev/null || exit 1

  # ===========================================================================
  # Process Compose - Orchestration commands
  # ===========================================================================

  up:
    desc: Start {{.Binary}} with process-compose TUI
    deps: [ensure]
    cmds:
      - '{{ "{{" }}.XPLAT{{ "}}" }} process up'

  up:detached:
    desc: Start {{.Binary}} in background
    deps: [ensure]
    cmds:
      - '{{ "{{" }}.XPLAT{{ "}}" }} process up -t=false -d'

  down:
    desc: Stop {{.Binary}}
    cmds:
      - '{{ "{{" }}.XPLAT{{ "}}" }} process down'

  # ===========================================================================
  # Development - Testing and dependencies
  # ===========================================================================

  test:
    desc: Run {{.Binary}} tests
    deps: [src:clone]
    dir: '{{ "{{" }}.SRC_DIR{{ "}}" }}'
    cmds:
{{if eq .Language "go"}}      - go test -v ./...
{{else if eq .Language "rust"}}      - cargo test
{{end}}
  deps:
    desc: Download {{.Binary}} dependencies
    deps: [src:clone]
    dir: '{{ "{{" }}.SRC_DIR{{ "}}" }}'
    cmds:
{{if eq .Language "go"}}      - go mod download
{{else if eq .Language "rust"}}      - cargo fetch
{{end}}
  # ===========================================================================
  # Clean - Remove generated artifacts
  # ===========================================================================

  clean:
    desc: Clean build artifacts
    cmds:
      - '{{ "{{" }}.XPLAT{{ "}}" }} os rm -rf {{ "{{" }}.BIN_DIR{{ "}}" }}'

  clean:src:
    desc: Clean source directory
    cmds:
      - '{{ "{{" }}.XPLAT{{ "}}" }} os rm -rf {{ "{{" }}.SRC_DIR{{ "}}" }}'

  clean:data:
    desc: Clean data directory
    cmds:
      - '{{ "{{" }}.XPLAT{{ "}}" }} os rm -rf {{ "{{" }}.DATA_DIR{{ "}}" }}'

  clean:all:
    desc: Clean everything (.src, .bin, .data)
    cmds:
      - '{{ "{{" }}.XPLAT{{ "}}" }} os rm -rf {{ "{{" }}.ROOT_DIR{{ "}}" }}/.src {{ "{{" }}.ROOT_DIR{{ "}}" }}/.bin {{ "{{" }}.ROOT_DIR{{ "}}" }}/.data'

  # ===========================================================================
  # Info - Version and manifest information
  # ===========================================================================

  version:
    desc: Show {{.Binary}} version
    deps: [ensure]
    cmds:
      - '{{ "{{" }}.BIN_PATH{{ "}}" }} --version || echo "{{ "{{" }}.VERSION{{ "}}" }}"'

  manifest:
    desc: Show pinned vs installed versions
    cmds:
      - |
        echo "=== {{.Binary}} Version ==="
        echo ""
        echo "Pinned:  {{ "{{" }}.VERSION{{ "}}" }}"
        if [ -f "{{ "{{" }}.BIN_DIR{{ "}}" }}/.version" ]; then
          echo "Installed:"
          cat "{{ "{{" }}.BIN_DIR{{ "}}" }}/.version"
        else
          echo "Installed: (not built)"
        fi

  # ===========================================================================
  # Release Commands (called by CI on tags)
  # ===========================================================================

  release:build:
    desc: Build release binary for current platform
    deps: [ensure]
    cmds:
      - '{{ "{{" }}.XPLAT{{ "}}" }} os mkdir -p {{ "{{" }}.ROOT_DIR{{ "}}" }}/.releases'
      - '{{ "{{" }}.XPLAT{{ "}}" }} os cp {{ "{{" }}.BIN_PATH{{ "}}" }} {{ "{{" }}.ROOT_DIR{{ "}}" }}/.releases/{{ "{{" }}.BINARY{{ "}}" }}-{{ "{{" }}OS{{ "}}" }}-{{ "{{" }}ARCH{{ "}}" }}{{ "{{" }}exeExt{{ "}}" }}'

  release:list:
    desc: List built release binaries
    cmds:
      - ls -la .releases/ 2>/dev/null || echo "No releases built yet"
{{else}}  # ===========================================================================
  # Build - Local project
  # ===========================================================================

  build:
    desc: Build the binary
    cmds:
{{if eq .Language "go"}}      - go build -o {{ "{{" }} .BINARY {{ "}}" }} {{ "{{" }} .MAIN {{ "}}" }}
{{else if eq .Language "rust"}}      - cargo build --release
{{end}}
  test:
    desc: Run tests
    cmds:
{{if .HasTests}}{{if eq .Language "go"}}      - go test ./...
{{else if eq .Language "rust"}}      - cargo test
{{end}}{{else}}      - echo "No tests yet"
{{end}}
  lint:
    desc: Run linter
    cmds:
{{if eq .Language "go"}}      - golangci-lint run || echo "golangci-lint not installed, skipping"
{{else if eq .Language "rust"}}      - cargo clippy || echo "clippy not installed, skipping"
{{end}}
  clean:
    desc: Clean build artifacts
    cmds:
{{if eq .Language "go"}}      - rm -f {{ "{{" }} .BINARY {{ "}}" }}
{{else if eq .Language "rust"}}      - cargo clean
{{end}}
  install:
    desc: Install to GOBIN
    cmds:
{{if eq .Language "go"}}      - go install {{ "{{" }} .MAIN {{ "}}" }}
{{else if eq .Language "rust"}}      - cargo install --path .
{{end}}
  run:
    desc: Build and run
    deps: [build]
    cmds:
      - ./{{ "{{" }} .BINARY {{ "}}" }}

  mod:
    desc: Tidy modules
    cmds:
{{if eq .Language "go"}}      - go mod tidy
{{else if eq .Language "rust"}}      - cargo update
{{end}}
  # ===========================================================================
  # Release Commands (called by CI on tags)
  # ===========================================================================

  release:build:
    desc: Build release binary for current platform
    cmds:
      - mkdir -p .releases
{{if eq .Language "go"}}      - go build -ldflags="-s -w" -o .releases/{{ "{{" }} .BINARY {{ "}}" }}-{{ "{{" }} OS {{ "}}" }}-{{ "{{" }} ARCH {{ "}}" }}{{ "{{" }} exeExt {{ "}}" }} {{ "{{" }} .MAIN {{ "}}" }}
{{else if eq .Language "rust"}}      - cargo build --release
      - cp target/release/{{ "{{" }} .BINARY {{ "}}" }}{{ "{{" }} exeExt {{ "}}" }} .releases/{{ "{{" }} .BINARY {{ "}}" }}-{{ "{{" }} OS {{ "}}" }}-{{ "{{" }} ARCH {{ "}}" }}{{ "{{" }} exeExt {{ "}}" }}
{{end}}
  release:list:
    desc: List built release binaries
    cmds:
      - ls -la .releases/ 2>/dev/null || echo "No releases built yet"
{{end}}
