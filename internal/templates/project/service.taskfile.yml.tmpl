# ============================================================================
# GENERATED FILE - DO NOT EDIT MANUALLY
# ============================================================================
# Generated by: xplat gen service
# Regenerate with: xplat gen service --force
# Source: https://github.com/joeblew999/xplat
# Template: internal/templates/project/service.taskfile.yml.tmpl
# ============================================================================
#
# Reusable service taskfile for remote inclusion by xplat consumers.
# Consumers include this via: xplat pkg install {{.Name}}
#
# Provides standardized service management tasks (start, stop, status)
# that work with the {{.BinaryName}} binary installed by xplat.
# ============================================================================

version: "3"

vars:
  {{.BinaryVarName}}_BIN: '{{"{{"}} .{{.BinaryVarName}}_BIN | default "{{.BinaryName}}" {{"}}"}}'
{{- if .Port}}
  {{.BinaryVarName}}_PORT: '{{"{{"}} .{{.BinaryVarName}}_PORT | default "{{.Port}}" {{"}}"}}'
{{- end}}
{{- if .Host}}
  {{.BinaryVarName}}_HOST: '{{"{{"}} .{{.BinaryVarName}}_HOST | default "{{.Host}}" {{"}}"}}'
{{- end}}
{{- range .ExtraVars}}
  {{.Name}}: '{{"{{"}} .{{.Name}} | default "{{.Default}}" {{"}}"}}'
{{- end}}

tasks:
  start:
    desc: Start the {{.Name}} service
    cmds:
      - '{{"{{"}} .{{.BinaryVarName}}_BIN {{"}}"}} serve{{if .Port}} --port {{"{{"}} .{{.BinaryVarName}}_PORT {{"}}"}}{{end}}{{if .Host}} --host {{"{{"}} .{{.BinaryVarName}}_HOST {{"}}"}}{{end}}'

  stop:
    desc: Stop the {{.Name}} service
    cmds:
      - pkill -f "{{"{{"}} .{{.BinaryVarName}}_BIN {{"}}"}} serve" || true

  status:
    desc: Check if {{.Name}} service is running
    cmds:
      - |
{{- if .HealthPath}}
        if curl -s http://{{"{{"}} .{{.BinaryVarName}}_HOST | default "127.0.0.1" {{"}}"}}:{{"{{"}} .{{.BinaryVarName}}_PORT {{"}}"}}/{{.HealthPath}} > /dev/null 2>&1; then
          echo "{{.Name}}: running on port {{"{{"}} .{{.BinaryVarName}}_PORT {{"}}"}}"
        else
          echo "{{.Name}}: not running"
          exit 1
        fi
{{- else}}
        if pgrep -f "{{"{{"}} .{{.BinaryVarName}}_BIN {{"}}"}} serve" > /dev/null; then
          echo "{{.Name}}: running"
        else
          echo "{{.Name}}: not running"
          exit 1
        fi
{{- end}}
{{- if .HealthPath}}

  health:
    desc: Check {{.Name}} service health endpoint
    cmds:
      - curl -s http://{{"{{"}} .{{.BinaryVarName}}_HOST | default "127.0.0.1" {{"}}"}}:{{"{{"}} .{{.BinaryVarName}}_PORT {{"}}"}}/{{.HealthPath}} | jq . || echo "{{.Name}}: not responding"
{{- end}}

  restart:
    desc: Restart the {{.Name}} service
    cmds:
      - task: stop
      - task: start
