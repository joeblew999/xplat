<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{{.Task.Name}} - xplat Task UI</title>
    <link href="/static/vendor/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/vendor/xterm.css">
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <strong>xplat</strong> Task UI
            </a>
            <span class="navbar-text text-muted">
                {{.WorkDir}}
            </span>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <!-- Sidebar with task list -->
            <div class="col-md-3 col-lg-2 d-none d-md-block">
                <div class="card">
                    <div class="card-header">Tasks</div>
                    <div class="list-group list-group-flush task-sidebar">
                        {{range .Tasks}}
                        <a href="/task/{{.Name}}" class="list-group-item list-group-item-action {{if eq .Name $.Task.Name}}active{{end}}">
                            {{.Name}}
                        </a>
                        {{end}}
                    </div>
                </div>
            </div>

            <!-- Main content -->
            <div class="col-md-9 col-lg-10">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-0">
                                <code>task {{.Task.Name}}</code>
                            </h5>
                            {{if .Task.Description}}
                            <small class="text-muted">{{.Task.Description}}</small>
                            {{end}}
                        </div>
                        <div>
                            <button id="runBtn" class="btn btn-success" onclick="runTask()">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-play-fill" viewBox="0 0 16 16">
                                    <path d="m11.596 8.697-6.363 3.692c-.54.313-1.233-.066-1.233-.697V4.308c0-.63.692-1.01 1.233-.696l6.363 3.692a.802.802 0 0 1 0 1.393z"/>
                                </svg>
                                Run
                            </button>
                            <a href="/" class="btn btn-outline-secondary">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-left" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"/>
                                </svg>
                                Back
                            </a>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div id="terminal"></div>
                    </div>
                    <div class="card-footer">
                        <small id="status" class="text-muted">Ready to run</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/vendor/xterm.min.js"></script>
    <script src="/static/vendor/addon-fit.min.js"></script>
    <script>
        const taskName = "{{.Task.Name}}";
        let term = null;
        let ws = null;
        let running = false;

        function initTerminal() {
            term = new Terminal({
                cursorBlink: true,
                fontSize: 14,
                fontFamily: 'Menlo, Monaco, "Courier New", monospace',
                theme: {
                    background: '#1e1e1e',
                    foreground: '#d4d4d4'
                }
            });

            const fitAddon = new FitAddon.FitAddon();
            term.loadAddon(fitAddon);
            term.open(document.getElementById('terminal'));
            fitAddon.fit();

            // Refit on window resize
            window.addEventListener('resize', () => fitAddon.fit());

            term.writeln('Click "Run" to execute: task ' + taskName);
            term.writeln('');
        }

        function runTask() {
            if (running) return;

            running = true;
            document.getElementById('runBtn').disabled = true;
            document.getElementById('status').textContent = 'Running...';

            // Clear terminal
            term.clear();
            term.writeln('\x1b[33mConnecting...\x1b[0m');
            term.writeln('');

            // Connect WebSocket
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(protocol + '//' + window.location.host + '/ws/' + taskName);

            ws.onopen = function() {
                term.clear();
            };

            ws.onmessage = function(e) {
                term.write(e.data);
            };

            ws.onclose = function() {
                running = false;
                document.getElementById('runBtn').disabled = false;
                document.getElementById('status').textContent = 'Finished';
            };

            ws.onerror = function(e) {
                term.writeln('\x1b[31mWebSocket error\x1b[0m');
                running = false;
                document.getElementById('runBtn').disabled = false;
                document.getElementById('status').textContent = 'Error';
            };

            // Send keyboard input to task (for interactive tasks)
            term.onData(function(data) {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(data);
                }
            });
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', initTerminal);
    </script>
</body>
</html>
