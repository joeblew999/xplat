# ============================================================================
# GENERATED FILE - DO NOT EDIT MANUALLY
# ============================================================================
# Generated by: xplat internal gen action
# Regenerate with: xplat internal gen action
# Source: https://github.com/joeblew999/xplat
# Template: internal/templates/xplat/action.yml.tmpl
# ============================================================================
#
# xplat Setup Action - Installs xplat binary for cross-platform CI/CD.
# Auto-detects OS and architecture.
#
# Usage:
#   - uses: joeblew999/xplat/.github/actions/setup@main
#     with:
#       version: v0.3.8  # optional, defaults to latest
#
#   # Build from source (latest main branch):
#   - uses: joeblew999/xplat/.github/actions/setup@main
#     with:
#       version: dev

name: 'Setup xplat'
description: 'Install xplat binary for cross-platform CI/CD'
author: 'joeblew999'

inputs:
  version:
    description: 'xplat version to install (e.g., v0.3.8, "dev" to build from source). Defaults to latest release.'
    required: false
    default: 'latest'

runs:
  using: 'composite'
  steps:
    # --- Dev mode: build from source ---
    - name: Build xplat from source
      if: inputs.version == 'dev' && runner.os != 'Windows'
      shell: bash
      run: |
        git clone --depth 1 https://github.com/joeblew999/xplat.git "$RUNNER_TEMP/xplat-src"
        cd "$RUNNER_TEMP/xplat-src"
        go build -o xplat .
        mkdir -p $HOME/.local/bin
        cp xplat $HOME/.local/bin/xplat
        chmod +x $HOME/.local/bin/xplat
        echo "$HOME/.local/bin" >> $GITHUB_PATH
        $HOME/.local/bin/xplat version

    - name: Build xplat from source (Windows)
      if: inputs.version == 'dev' && runner.os == 'Windows'
      shell: bash
      run: |
        git clone --depth 1 https://github.com/joeblew999/xplat.git "$RUNNER_TEMP/xplat-src"
        cd "$RUNNER_TEMP/xplat-src"
        go build -o xplat.exe .
        mkdir -p "$USERPROFILE/bin"
        cp xplat.exe "$USERPROFILE/bin/xplat.exe"
        echo "$USERPROFILE/bin" >> $GITHUB_PATH
        "$USERPROFILE/bin/xplat.exe" version

    # --- Release mode: download pre-built binary ---
    - name: Determine xplat version
      if: inputs.version != 'dev'
      id: version
      shell: bash
      run: |
        set +e  # Don't exit on error for version detection
        VERSION="${{ inputs.version }}"
        if [ "$VERSION" = "latest" ]; then
          RELEASE_JSON=$(curl -sL https://api.github.com/repos/joeblew999/xplat/releases/latest)
          VERSION=$(echo "$RELEASE_JSON" | grep '"tag_name"' | cut -d'"' -f4 | sed 's/xplat-//')
          if [ -z "$VERSION" ]; then
            echo "Failed to get latest version. API response:"
            echo "$RELEASE_JSON" | head -20
            exit 1
          fi
        fi
        set -e
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Installing xplat $VERSION"

    - name: Determine binary name
      if: inputs.version != 'dev'
      id: binary
      shell: bash
      run: |
        OS="${{ runner.os }}"
        ARCH="${{ runner.arch }}"

        # Map runner.os to binary name
        case "$OS" in
          Linux)  OS_NAME="linux" ;;
          macOS)  OS_NAME="darwin" ;;
          Windows) OS_NAME="windows" ;;
        esac

        # Map runner.arch to binary name
        case "$ARCH" in
          X64)   ARCH_NAME="amd64" ;;
          ARM64) ARCH_NAME="arm64" ;;
        esac

        BINARY="xplat-${OS_NAME}-${ARCH_NAME}"
        if [ "$OS" = "Windows" ]; then
          BINARY="${BINARY}.exe"
        fi

        echo "binary=$BINARY" >> $GITHUB_OUTPUT
        echo "Binary: $BINARY"

    - name: Install xplat (Unix)
      if: inputs.version != 'dev' && runner.os != 'Windows'
      shell: bash
      run: |
        mkdir -p $HOME/.local/bin
        curl -sL "https://github.com/joeblew999/xplat/releases/download/xplat-${{ steps.version.outputs.version }}/${{ steps.binary.outputs.binary }}" -o $HOME/.local/bin/xplat
        chmod +x $HOME/.local/bin/xplat
        echo "$HOME/.local/bin" >> $GITHUB_PATH
        $HOME/.local/bin/xplat version

    - name: Install xplat (Windows)
      if: inputs.version != 'dev' && runner.os == 'Windows'
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path "$env:USERPROFILE\bin" | Out-Null
        Invoke-WebRequest -Uri "https://github.com/joeblew999/xplat/releases/download/xplat-${{ steps.version.outputs.version }}/${{ steps.binary.outputs.binary }}" -OutFile "$env:USERPROFILE\bin\xplat.exe"
        echo "$env:USERPROFILE\bin" | Out-File -FilePath $env:GITHUB_PATH -Append
        & "$env:USERPROFILE\bin\xplat.exe" version
