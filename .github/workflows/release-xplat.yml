# xplat Cross-Platform Build & Release
#
# Builds the xplat binary for all major platforms and releases
# to GitHub Releases when a tag matching xplat-v* is pushed.
#
# Usage:
#   git tag xplat-v0.1.0
#   git push origin xplat-v0.1.0

name: "[Release] xplat"

on:
  push:
    tags: ['xplat-v*']
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., v0.1.0)'
        required: true
        default: 'dev'

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            goos: linux
            goarch: amd64
            ext: ''
          - os: ubuntu-latest
            goos: linux
            goarch: arm64
            ext: ''
          - os: macos-latest
            goos: darwin
            goarch: amd64
            ext: ''
          - os: macos-latest
            goos: darwin
            goarch: arm64
            ext: ''
          - os: windows-latest
            goos: windows
            goarch: amd64
            ext: '.exe'
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Determine version
        id: version
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            # Extract version from tag (xplat-v0.1.0 -> v0.1.0)
            echo "version=${GITHUB_REF_NAME#xplat-}" >> $GITHUB_OUTPUT
          fi

      - name: Build xplat
        shell: bash
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: '0'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          OUTPUT="xplat-${{ matrix.goos }}-${{ matrix.goarch }}${{ matrix.ext }}"
          go build -ldflags="-s -w -X main.Version=${VERSION}" -o "${OUTPUT}" ./cmd/xplat
          echo "Built ${OUTPUT}"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: xplat-${{ matrix.goos }}-${{ matrix.goarch }}
          path: xplat-${{ matrix.goos }}-${{ matrix.goarch }}${{ matrix.ext }}

  # Test xplat on all platforms
  test:
    needs: build
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            artifact: xplat-linux-amd64
            binary: xplat-linux-amd64
          - os: macos-latest
            artifact: xplat-darwin-arm64
            binary: xplat-darwin-arm64
          - os: windows-latest
            artifact: xplat-windows-amd64
            binary: xplat-windows-amd64.exe
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: bin

      - name: Test xplat (Unix)
        if: runner.os != 'Windows'
        run: |
          chmod +x bin/${{ matrix.binary }}
          export PATH="$PWD/bin:$PATH"
          mv bin/${{ matrix.binary }} bin/xplat

          echo "=== xplat Test Suite (Unix) ==="
          echo ""

          echo "Testing: version"
          bin/xplat version
          echo "  OK"

          echo ""
          echo "Testing: which"
          bin/xplat which bash || bin/xplat which sh
          echo "  OK"

          echo ""
          echo "Testing: glob"
          COUNT=$(bin/xplat glob "cmd/**/*.go" | wc -l)
          echo "  Found $COUNT Go files"
          [ "$COUNT" -gt 0 ] && echo "  OK" || exit 1

          echo ""
          echo "Testing: mkdir -p"
          bin/xplat mkdir -p /tmp/xplat-test/nested/dir
          [ -d /tmp/xplat-test/nested/dir ] && echo "  OK" || exit 1

          echo ""
          echo "Testing: touch"
          bin/xplat touch /tmp/xplat-test/testfile.txt
          [ -f /tmp/xplat-test/testfile.txt ] && echo "  OK" || exit 1

          echo ""
          echo "Testing: cat"
          echo "hello world" > /tmp/xplat-test/testfile.txt
          CONTENT=$(bin/xplat cat /tmp/xplat-test/testfile.txt)
          [ "$CONTENT" = "hello world" ] && echo "  OK" || exit 1

          echo ""
          echo "Testing: cp"
          bin/xplat cp /tmp/xplat-test/testfile.txt /tmp/xplat-test/copied.txt
          [ -f /tmp/xplat-test/copied.txt ] && echo "  OK" || exit 1

          echo ""
          echo "Testing: cp -r"
          bin/xplat cp -r /tmp/xplat-test/nested /tmp/xplat-test/nested-copy
          [ -d /tmp/xplat-test/nested-copy/dir ] && echo "  OK" || exit 1

          echo ""
          echo "Testing: mv (rename)"
          bin/xplat touch /tmp/xplat-test/to-rename.txt
          bin/xplat mv /tmp/xplat-test/to-rename.txt /tmp/xplat-test/renamed.txt
          [ -f /tmp/xplat-test/renamed.txt ] && [ ! -f /tmp/xplat-test/to-rename.txt ] && echo "  OK" || exit 1

          echo ""
          echo "Testing: mv (to directory)"
          bin/xplat mv /tmp/xplat-test/renamed.txt /tmp/xplat-test/nested/
          [ -f /tmp/xplat-test/nested/renamed.txt ] && echo "  OK" || exit 1

          echo ""
          echo "Testing: env"
          HOME_VAL=$(bin/xplat env HOME)
          [ -n "$HOME_VAL" ] && echo "  OK: HOME=$HOME_VAL" || exit 1

          echo ""
          echo "Testing: env -d (default)"
          VAL=$(bin/xplat env NONEXISTENT_12345 -d "default")
          [ "$VAL" = "default" ] && echo "  OK" || exit 1

          echo ""
          echo "Testing: rm"
          bin/xplat rm /tmp/xplat-test/copied.txt
          [ ! -f /tmp/xplat-test/copied.txt ] && echo "  OK" || exit 1

          echo ""
          echo "Testing: rm -rf"
          bin/xplat rm -rf /tmp/xplat-test
          [ ! -d /tmp/xplat-test ] && echo "  OK" || exit 1

          echo ""
          echo "=== All tests passed (Unix) ==="

      - name: Test xplat (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $bin = "bin\${{ matrix.binary }}"

          Write-Host "=== xplat Test Suite (Windows) ===" -ForegroundColor Cyan
          Write-Host ""

          Write-Host "Testing: version"
          & $bin version
          Write-Host "  OK" -ForegroundColor Green

          Write-Host ""
          Write-Host "Testing: which"
          & $bin which powershell
          Write-Host "  OK" -ForegroundColor Green

          Write-Host ""
          Write-Host "Testing: glob"
          $count = (& $bin glob "cmd/**/*.go" | Measure-Object -Line).Lines
          Write-Host "  Found $count Go files"
          if ($count -gt 0) { Write-Host "  OK" -ForegroundColor Green } else { exit 1 }

          Write-Host ""
          Write-Host "Testing: mkdir -p"
          & $bin mkdir -p "$env:TEMP\xplat-test\nested\dir"
          if (Test-Path "$env:TEMP\xplat-test\nested\dir") { Write-Host "  OK" -ForegroundColor Green } else { exit 1 }

          Write-Host ""
          Write-Host "Testing: touch"
          & $bin touch "$env:TEMP\xplat-test\testfile.txt"
          if (Test-Path "$env:TEMP\xplat-test\testfile.txt") { Write-Host "  OK" -ForegroundColor Green } else { exit 1 }

          Write-Host ""
          Write-Host "Testing: cat"
          "hello world" | Out-File -FilePath "$env:TEMP\xplat-test\testfile.txt" -Encoding utf8 -NoNewline
          $content = & $bin cat "$env:TEMP\xplat-test\testfile.txt"
          if ($content.Trim() -eq "hello world") { Write-Host "  OK" -ForegroundColor Green } else { Write-Host "  Got: $content"; exit 1 }

          Write-Host ""
          Write-Host "Testing: cp"
          & $bin cp "$env:TEMP\xplat-test\testfile.txt" "$env:TEMP\xplat-test\copied.txt"
          if (Test-Path "$env:TEMP\xplat-test\copied.txt") { Write-Host "  OK" -ForegroundColor Green } else { exit 1 }

          Write-Host ""
          Write-Host "Testing: cp -r"
          & $bin cp -r "$env:TEMP\xplat-test\nested" "$env:TEMP\xplat-test\nested-copy"
          if (Test-Path "$env:TEMP\xplat-test\nested-copy\dir") { Write-Host "  OK" -ForegroundColor Green } else { exit 1 }

          Write-Host ""
          Write-Host "Testing: mv (rename)"
          & $bin touch "$env:TEMP\xplat-test\to-rename.txt"
          & $bin mv "$env:TEMP\xplat-test\to-rename.txt" "$env:TEMP\xplat-test\renamed.txt"
          if ((Test-Path "$env:TEMP\xplat-test\renamed.txt") -and (-not (Test-Path "$env:TEMP\xplat-test\to-rename.txt"))) { Write-Host "  OK" -ForegroundColor Green } else { exit 1 }

          Write-Host ""
          Write-Host "Testing: mv (to directory)"
          & $bin mv "$env:TEMP\xplat-test\renamed.txt" "$env:TEMP\xplat-test\nested\"
          if (Test-Path "$env:TEMP\xplat-test\nested\renamed.txt") { Write-Host "  OK" -ForegroundColor Green } else { exit 1 }

          Write-Host ""
          Write-Host "Testing: env"
          $homeVal = & $bin env USERPROFILE
          if ($homeVal) { Write-Host "  OK: USERPROFILE=$homeVal" -ForegroundColor Green } else { exit 1 }

          Write-Host ""
          Write-Host "Testing: env -d (default)"
          $val = & $bin env NONEXISTENT_12345 -d "default"
          if ($val -eq "default") { Write-Host "  OK" -ForegroundColor Green } else { exit 1 }

          Write-Host ""
          Write-Host "Testing: rm"
          & $bin rm "$env:TEMP\xplat-test\copied.txt"
          if (-not (Test-Path "$env:TEMP\xplat-test\copied.txt")) { Write-Host "  OK" -ForegroundColor Green } else { exit 1 }

          Write-Host ""
          Write-Host "Testing: rm -rf"
          & $bin rm -rf "$env:TEMP\xplat-test"
          if (-not (Test-Path "$env:TEMP\xplat-test")) { Write-Host "  OK" -ForegroundColor Green } else { exit 1 }

          Write-Host ""
          Write-Host "=== All tests passed (Windows) ===" -ForegroundColor Cyan

  release:
    needs: [build, test]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/xplat-v')
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release files
        run: |
          # Show artifact structure
          echo "=== Artifact structure ==="
          find artifacts -type f

          # Move all binaries to release/ directory
          mkdir -p release
          find artifacts -type f -name 'xplat-*' -exec mv {} release/ \;

          echo ""
          echo "=== Release files ==="
          ls -la release/

      - name: Create Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Create release notes file
          cat > /tmp/release-notes.md << 'EOF'
          ## xplat - Cross-platform utilities for Taskfile

          Download the binary for your platform and add it to your PATH.

          ### Installation

          ```bash
          # macOS (Apple Silicon)
          curl -sL https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/xplat-darwin-arm64 -o /usr/local/bin/xplat
          chmod +x /usr/local/bin/xplat

          # macOS (Intel)
          curl -sL https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/xplat-darwin-amd64 -o /usr/local/bin/xplat
          chmod +x /usr/local/bin/xplat

          # Linux (x86_64)
          curl -sL https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/xplat-linux-amd64 -o ~/.local/bin/xplat
          chmod +x ~/.local/bin/xplat

          # Linux (ARM64)
          curl -sL https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/xplat-linux-arm64 -o ~/.local/bin/xplat
          chmod +x ~/.local/bin/xplat
          ```

          ### Commands

          ```
          # Core (P0)
          xplat version          # Print version
          xplat which <binary>   # Find binary in PATH
          xplat glob <pattern>   # Expand glob pattern (supports **)

          # File Operations (P1)
          xplat rm [-rf] <path>  # Remove files or directories
          xplat mkdir [-p] <dir> # Create directories
          xplat cp [-r] <s> <d>  # Copy files or directories
          xplat mv <src> <dst>   # Move or rename files/directories

          # Utilities (P2)
          xplat cat <file>       # Print file contents
          xplat touch <file>     # Create or update file
          xplat env <key> [-d v] # Get environment variable
          ```
          EOF

          # Create release with gh CLI (replaces softprops/action-gh-release)
          gh release create "${{ github.ref_name }}" \
            --title "xplat ${GITHUB_REF_NAME#xplat-}" \
            --notes-file /tmp/release-notes.md \
            release/*
