# Test workflow for dummy tools FULL round-trip
# Tests BOTH CGO=0 and CGO=1 to validate xplat smart build:
#
# CGO=0 (dummy):     Single ci:test task does full round-trip
# CGO=1 (dummy-cgo): Each platform builds native + uploads to shared release
#
# Uses gh taskfile for release operations (no upload-artifact)
#
# Bootstrap: xplat embeds Task, so we only need to build xplat from source.
#
name: "Test: Dummy Round-Trip"

on:
  workflow_dispatch:
  push:
    paths:
      - 'cmd/dummy/**'
      - 'cmd/dummy-cgo/**'
      - 'cmd/xplat/**'
      - 'taskfiles/Taskfile.dummy*.yml'
      - 'taskfiles/toolchain/Taskfile.golang.yml'
      - 'taskfiles/tools/Taskfile.xplat.yml'
      - '.github/workflows/test-dummy.yml'

env:
  # Test release tags - include run ID to avoid conflicts
  DUMMY_TEST_VERSION: v0.0.0-test-${{ github.run_id }}
  DUMMY_CGO_TEST_VERSION: v0.0.0-cgo-test-${{ github.run_id }}
  GH_TOKEN: ${{ github.token }}

jobs:
  # ===========================================================================
  # CGO=0: Single ci:test does full round-trip
  # ===========================================================================
  test-cgo0:
    name: "CGO=0 Test"
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Cache xplat binary
        id: cache-xplat
        uses: actions/cache@v4
        with:
          path: ~/.local/bin/xplat
          key: xplat-linux-${{ hashFiles('cmd/xplat/**', 'go.mod', 'go.sum') }}

      - name: Build xplat (with embedded Task)
        if: steps.cache-xplat.outputs.cache-hit != 'true'
        run: |
          mkdir -p "$HOME/.local/bin"
          go build -o "$HOME/.local/bin/xplat" ./cmd/xplat

      - name: Add xplat to PATH
        run: echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Run ci:test (full round-trip, skip cleanup for verify jobs)
        run: xplat task dummy:ci:test VERSION=${{ env.DUMMY_TEST_VERSION }} SKIP_CLEANUP=true

  # ===========================================================================
  # CGO=0: Verify downloaded binary works on each platform
  # ===========================================================================
  verify-cgo0:
    name: "CGO=0 Verify (${{ matrix.os }})"
    needs: test-cgo0
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            binary: dummy-linux-amd64
          - os: macos-latest
            binary: dummy-darwin-arm64
          - os: windows-latest
            binary: dummy-windows-amd64.exe
    runs-on: ${{ matrix.os }}
    steps:
      - name: Download and verify binary
        shell: bash
        run: |
          URL="https://github.com/${{ github.repository }}/releases/download/dummy-${{ env.DUMMY_TEST_VERSION }}/${{ matrix.binary }}"
          echo "Downloading: $URL"
          # Retry up to 3 times with 5s delay (release assets may take a moment to propagate)
          for i in 1 2 3; do
            if curl -sfL "$URL" -o dummy; then
              echo "Download succeeded on attempt $i"
              break
            fi
            if [ $i -eq 3 ]; then
              echo "ERROR: Failed to download after 3 attempts"
              exit 1
            fi
            echo "Attempt $i failed, retrying in 5s..."
            sleep 5
          done
          chmod +x dummy 2>/dev/null || true
          ./dummy
          echo "OK: Downloaded binary works!"

  # ===========================================================================
  # CGO=0: Cleanup test release
  # ===========================================================================
  cleanup-cgo0:
    name: "CGO=0 Cleanup"
    needs: verify-cgo0
    if: always()
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Delete test release
        run: gh release delete "dummy-${{ env.DUMMY_TEST_VERSION }}" --repo "${{ github.repository }}" --yes --cleanup-tag || true

  # ===========================================================================
  # CGO=1: Create empty release first
  # ===========================================================================
  create-release-cgo1:
    name: "CGO=1 Create Release"
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Create empty release
        run: |
          gh release delete "dummy-cgo-${{ env.DUMMY_CGO_TEST_VERSION }}" --repo "${{ github.repository }}" --yes --cleanup-tag || true
          gh release create "dummy-cgo-${{ env.DUMMY_CGO_TEST_VERSION }}" --repo "${{ github.repository }}" --title "dummy-cgo-${{ env.DUMMY_CGO_TEST_VERSION }}" --notes "CGO=1 test release"

  # ===========================================================================
  # CGO=1: Each platform builds + uploads to the shared release
  # ===========================================================================
  build-cgo1:
    name: "CGO=1 Build (${{ matrix.os }})"
    needs: create-release-cgo1
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Set HOME on Windows
        if: runner.os == 'Windows'
        shell: bash
        run: echo "HOME=$USERPROFILE" >> $GITHUB_ENV

      - name: Cache xplat binary
        id: cache-xplat
        uses: actions/cache@v4
        with:
          path: |
            ~/.local/bin/xplat
            ~/bin/xplat.exe
          key: xplat-${{ runner.os }}-${{ hashFiles('cmd/xplat/**', 'go.mod', 'go.sum') }}

      - name: Build xplat (with embedded Task)
        if: steps.cache-xplat.outputs.cache-hit != 'true'
        shell: bash
        run: |
          if [ "$RUNNER_OS" == "Windows" ]; then
            mkdir -p "$HOME/bin"
            go build -o "$HOME/bin/xplat.exe" ./cmd/xplat
          else
            mkdir -p "$HOME/.local/bin"
            go build -o "$HOME/.local/bin/xplat" ./cmd/xplat
          fi

      - name: Add xplat to PATH
        shell: bash
        run: |
          if [ "$RUNNER_OS" == "Windows" ]; then
            echo "$HOME/bin" >> $GITHUB_PATH
          else
            echo "$HOME/.local/bin" >> $GITHUB_PATH
          fi

      - name: Verify xplat task
        shell: bash
        run: xplat task --version

      - name: Build dummy-cgo (dev)
        shell: bash
        run: xplat task dummy-cgo:build

      - name: Release build
        shell: bash
        run: xplat task dummy-cgo:release:build

      - name: Test release binary
        shell: bash
        run: xplat task dummy-cgo:release:test

      - name: Platform build (xplat smart build)
        shell: bash
        run: xplat release build dummy-cgo

      - name: Verify binaries built
        shell: bash
        run: xplat task dummy-cgo:release:verify

      - name: Upload binaries to release
        shell: bash
        run: |
          echo "Uploading binaries..."
          FILES=$(xplat release list dummy-cgo | tr '\n' ' ')
          xplat task tools:gh:release:upload -- "dummy-cgo-${{ env.DUMMY_CGO_TEST_VERSION }}" $FILES

      - name: Run dummy-cgo
        shell: bash
        run: xplat task dummy-cgo:run

  # ===========================================================================
  # CGO=1: Verify downloaded binary works on each platform
  # ===========================================================================
  verify-cgo1:
    name: "CGO=1 Verify (${{ matrix.os }})"
    needs: build-cgo1
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            binary: dummy-cgo-linux-amd64
          - os: macos-latest
            binary: dummy-cgo-darwin-arm64
          - os: windows-latest
            binary: dummy-cgo-windows-amd64.exe
    runs-on: ${{ matrix.os }}
    steps:
      - name: Download and verify binary
        shell: bash
        run: |
          URL="https://github.com/${{ github.repository }}/releases/download/dummy-cgo-${{ env.DUMMY_CGO_TEST_VERSION }}/${{ matrix.binary }}"
          echo "Downloading: $URL"
          # Retry up to 3 times with 5s delay (release assets may take a moment to propagate)
          for i in 1 2 3; do
            if curl -sfL "$URL" -o dummy-cgo; then
              echo "Download succeeded on attempt $i"
              break
            fi
            if [ $i -eq 3 ]; then
              echo "ERROR: Failed to download after 3 attempts"
              exit 1
            fi
            echo "Attempt $i failed, retrying in 5s..."
            sleep 5
          done
          chmod +x dummy-cgo 2>/dev/null || true
          ./dummy-cgo
          echo "OK: Downloaded CGO=1 binary works!"

  # ===========================================================================
  # CGO=1: Cleanup test release
  # ===========================================================================
  cleanup-cgo1:
    name: "CGO=1 Cleanup"
    needs: verify-cgo1
    if: always()
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Delete test release
        run: gh release delete "dummy-cgo-${{ env.DUMMY_CGO_TEST_VERSION }}" --repo "${{ github.repository }}" --yes --cleanup-tag || true
