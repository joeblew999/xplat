# xplat Cross-Platform Tests
#
# Runs on every push/PR to ensure xplat works on all platforms.
# This catches Windows compatibility issues early.

name: "[Core] xplat"

on:
  push:
    branches: [main]
    paths:
      - '*.go'
      - 'cmd/**'
      - 'internal/**'
      - '.github/workflows/core-xplat.yml'
  pull_request:
    paths:
      - '*.go'
      - 'cmd/**'
      - 'internal/**'
  workflow_dispatch:

jobs:
  test:
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            name: Linux
          - os: macos-latest
            name: macOS
          - os: windows-latest
            name: Windows
    runs-on: ${{ matrix.os }}
    name: Test (${{ matrix.name }})
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Build xplat
        shell: bash
        run: |
          go build -o xplat${{ runner.os == 'Windows' && '.exe' || '' }} .
          echo "Built xplat for ${{ matrix.name }}"

      - name: Run Go tests
        run: go test -v ./...

      - name: Test xplat commands (Unix)
        if: runner.os != 'Windows'
        run: |
          echo "=== xplat Test Suite (${{ matrix.name }}) ==="

          echo "Testing: version"
          ./xplat version

          echo "Testing: os which"
          ./xplat os which go

          echo "Testing: os glob"
          COUNT=$(./xplat os glob "cmd/**/*.go" | wc -l)
          echo "  Found $COUNT Go files"
          [ "$COUNT" -gt 0 ] || exit 1

          echo "Testing: os mkdir -p"
          ./xplat os mkdir -p /tmp/xplat-ci-test/nested/dir
          [ -d /tmp/xplat-ci-test/nested/dir ] || exit 1

          echo "Testing: os touch"
          ./xplat os touch /tmp/xplat-ci-test/testfile.txt
          [ -f /tmp/xplat-ci-test/testfile.txt ] || exit 1

          echo "Testing: os cat"
          echo "test content" > /tmp/xplat-ci-test/testfile.txt
          CONTENT=$(./xplat os cat /tmp/xplat-ci-test/testfile.txt)
          [ "$CONTENT" = "test content" ] || exit 1

          echo "Testing: os cp"
          ./xplat os cp /tmp/xplat-ci-test/testfile.txt /tmp/xplat-ci-test/copied.txt
          [ -f /tmp/xplat-ci-test/copied.txt ] || exit 1

          echo "Testing: os cp -r"
          ./xplat os cp -r /tmp/xplat-ci-test/nested /tmp/xplat-ci-test/nested-copy
          [ -d /tmp/xplat-ci-test/nested-copy/dir ] || exit 1

          echo "Testing: os mv (rename)"
          ./xplat os touch /tmp/xplat-ci-test/to-rename.txt
          ./xplat os mv /tmp/xplat-ci-test/to-rename.txt /tmp/xplat-ci-test/renamed.txt
          [ -f /tmp/xplat-ci-test/renamed.txt ] || exit 1
          [ ! -f /tmp/xplat-ci-test/to-rename.txt ] || exit 1

          echo "Testing: os mv (to directory)"
          ./xplat os mv /tmp/xplat-ci-test/renamed.txt /tmp/xplat-ci-test/nested/
          [ -f /tmp/xplat-ci-test/nested/renamed.txt ] || exit 1

          echo "Testing: os env"
          ./xplat os env HOME

          echo "Testing: os env -d"
          VAL=$(./xplat os env NONEXISTENT -d "fallback")
          [ "$VAL" = "fallback" ] || exit 1

          echo "Testing: os rm"
          ./xplat os rm /tmp/xplat-ci-test/copied.txt
          [ ! -f /tmp/xplat-ci-test/copied.txt ] || exit 1

          echo "Testing: os rm -rf"
          ./xplat os rm -rf /tmp/xplat-ci-test
          [ ! -d /tmp/xplat-ci-test ] || exit 1

          echo "=== All tests passed (${{ matrix.name }}) ==="

      - name: Test xplat commands (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          Write-Host "=== xplat Test Suite (Windows) ===" -ForegroundColor Cyan

          Write-Host "Testing: version"
          .\xplat.exe version

          Write-Host "Testing: os which"
          .\xplat.exe os which powershell

          Write-Host "Testing: os glob"
          $count = (.\xplat.exe os glob "cmd/**/*.go" | Measure-Object -Line).Lines
          Write-Host "  Found $count Go files"
          if ($count -le 0) { exit 1 }

          Write-Host "Testing: os mkdir -p"
          .\xplat.exe os mkdir -p "$env:TEMP\xplat-ci-test\nested\dir"
          if (-not (Test-Path "$env:TEMP\xplat-ci-test\nested\dir")) { exit 1 }

          Write-Host "Testing: os touch"
          .\xplat.exe os touch "$env:TEMP\xplat-ci-test\testfile.txt"
          if (-not (Test-Path "$env:TEMP\xplat-ci-test\testfile.txt")) { exit 1 }

          Write-Host "Testing: os cat"
          "test content" | Out-File -FilePath "$env:TEMP\xplat-ci-test\testfile.txt" -Encoding utf8 -NoNewline
          $content = .\xplat.exe os cat "$env:TEMP\xplat-ci-test\testfile.txt"
          if ($content.Trim() -ne "test content") { Write-Host "Got: $content"; exit 1 }

          Write-Host "Testing: os cp"
          .\xplat.exe os cp "$env:TEMP\xplat-ci-test\testfile.txt" "$env:TEMP\xplat-ci-test\copied.txt"
          if (-not (Test-Path "$env:TEMP\xplat-ci-test\copied.txt")) { exit 1 }

          Write-Host "Testing: os cp -r"
          .\xplat.exe os cp -r "$env:TEMP\xplat-ci-test\nested" "$env:TEMP\xplat-ci-test\nested-copy"
          if (-not (Test-Path "$env:TEMP\xplat-ci-test\nested-copy\dir")) { exit 1 }

          Write-Host "Testing: os mv (rename)"
          .\xplat.exe os touch "$env:TEMP\xplat-ci-test\to-rename.txt"
          .\xplat.exe os mv "$env:TEMP\xplat-ci-test\to-rename.txt" "$env:TEMP\xplat-ci-test\renamed.txt"
          if (-not (Test-Path "$env:TEMP\xplat-ci-test\renamed.txt")) { exit 1 }
          if (Test-Path "$env:TEMP\xplat-ci-test\to-rename.txt") { exit 1 }

          Write-Host "Testing: os mv (to directory)"
          .\xplat.exe os mv "$env:TEMP\xplat-ci-test\renamed.txt" "$env:TEMP\xplat-ci-test\nested\"
          if (-not (Test-Path "$env:TEMP\xplat-ci-test\nested\renamed.txt")) { exit 1 }

          Write-Host "Testing: os env"
          .\xplat.exe os env USERPROFILE

          Write-Host "Testing: os env -d"
          $val = .\xplat.exe os env NONEXISTENT -d "fallback"
          if ($val -ne "fallback") { exit 1 }

          Write-Host "Testing: os rm"
          .\xplat.exe os rm "$env:TEMP\xplat-ci-test\copied.txt"
          if (Test-Path "$env:TEMP\xplat-ci-test\copied.txt") { exit 1 }

          Write-Host "Testing: os rm -rf"
          .\xplat.exe os rm -rf "$env:TEMP\xplat-ci-test"
          if (Test-Path "$env:TEMP\xplat-ci-test") { exit 1 }

          Write-Host "=== All tests passed (Windows) ===" -ForegroundColor Cyan
