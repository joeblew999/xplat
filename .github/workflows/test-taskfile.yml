# Generic Taskfile Testing Workflow
#
# Tests any taskfile using xplat's archetype-aware test command.
# Uses xplat test --info to detect archetype and affinity, then runs
# appropriate test strategy.
#
# Archetypes: tool, external, builder, aggregation, bootstrap, unknown
# Affinity: cross (can cross-compile) or native (must build per-platform)
#
# Bootstrap: xplat embeds Task, so we only need to build xplat from source.
#
name: "Test: Taskfile"

on:
  workflow_dispatch:
    inputs:
      namespace:
        description: 'Taskfile namespace to test (e.g., dummy, wrangler, golang)'
        required: true
        type: string
      multi_platform:
        description: 'Test on all platforms (for external/validation)'
        required: false
        type: boolean
        default: false
      skip_cleanup:
        description: 'Skip cleanup of test releases (for debugging)'
        required: false
        type: boolean
        default: false

env:
  GH_TOKEN: ${{ github.token }}
  TEST_VERSION: v0.0.0-test-${{ github.run_id }}

jobs:
  # ===========================================================================
  # Detect archetype and affinity using xplat
  # ===========================================================================
  detect:
    name: "Detect"
    runs-on: ubuntu-latest
    outputs:
      archetype: ${{ steps.detect.outputs.archetype }}
      affinity: ${{ steps.detect.outputs.affinity }}
      namespace: ${{ steps.detect.outputs.namespace }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Build xplat
        run: |
          mkdir -p "$HOME/.local/bin"
          go build -o "$HOME/.local/bin/xplat" ./cmd/xplat
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Detect archetype and affinity
        id: detect
        run: |
          # Use xplat test --info for detection
          INFO=$(xplat test ${{ inputs.namespace }} --info)
          echo "$INFO"

          # Parse key=value output
          ARCHETYPE=$(echo "$INFO" | grep "^archetype=" | cut -d= -f2)
          AFFINITY=$(echo "$INFO" | grep "^affinity=" | cut -d= -f2)
          NAMESPACE=$(echo "$INFO" | grep "^namespace=" | cut -d= -f2)

          echo "archetype=$ARCHETYPE" >> $GITHUB_OUTPUT
          echo "affinity=$AFFINITY" >> $GITHUB_OUTPUT
          echo "namespace=$NAMESPACE" >> $GITHUB_OUTPUT

          echo "Detected: archetype=$ARCHETYPE, affinity=$AFFINITY, namespace=$NAMESPACE"

      - name: Show test plan
        run: xplat test ${{ inputs.namespace }} --dry-run

  # ===========================================================================
  # TOOL (cross): Build on single platform, optionally verify on all
  # ===========================================================================
  test-tool-cross:
    name: "Tool Test (cross)"
    needs: detect
    if: needs.detect.outputs.archetype == 'tool' && needs.detect.outputs.affinity == 'cross'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Build xplat
        run: |
          mkdir -p "$HOME/.local/bin"
          go build -o "$HOME/.local/bin/xplat" ./cmd/xplat
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Run tests
        run: xplat test ${{ needs.detect.outputs.namespace }}

      - name: Cross-compile + release (if multi_platform)
        if: inputs.multi_platform
        run: |
          echo "=== Cross-compile all platforms ==="
          RELEASE_VERSION=${{ env.TEST_VERSION }} xplat release build ${{ needs.detect.outputs.namespace }}

          echo "=== Create test release ==="
          gh release delete "${{ needs.detect.outputs.namespace }}-${{ env.TEST_VERSION }}" --yes --cleanup-tag 2>/dev/null || true
          xplat task tools:gh:release:publish NAME=${{ needs.detect.outputs.namespace }} VERSION=${{ env.TEST_VERSION }}

  verify-tool-cross:
    name: "Verify (${{ matrix.os }})"
    needs: [detect, test-tool-cross]
    if: needs.detect.outputs.archetype == 'tool' && needs.detect.outputs.affinity == 'cross' && inputs.multi_platform
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            suffix: linux-amd64
          - os: macos-latest
            suffix: darwin-arm64
          - os: windows-latest
            suffix: windows-amd64.exe
    runs-on: ${{ matrix.os }}
    steps:
      - name: Download and verify
        shell: bash
        run: |
          BINARY="${{ needs.detect.outputs.namespace }}-${{ matrix.suffix }}"
          URL="https://github.com/${{ github.repository }}/releases/download/${{ needs.detect.outputs.namespace }}-${{ env.TEST_VERSION }}/$BINARY"
          echo "Downloading: $URL"
          for i in 1 2 3; do
            curl -sfL "$URL" -o testbin && break
            [ $i -eq 3 ] && echo "ERROR: Failed to download" && exit 1
            sleep 5
          done
          chmod +x testbin 2>/dev/null || true
          ./testbin
          echo "OK: Binary works!"

  cleanup-tool-cross:
    name: "Cleanup"
    needs: [detect, verify-tool-cross]
    if: always() && needs.detect.outputs.archetype == 'tool' && needs.detect.outputs.affinity == 'cross' && inputs.multi_platform && !inputs.skip_cleanup
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Delete test release
        run: gh release delete "${{ needs.detect.outputs.namespace }}-${{ env.TEST_VERSION }}" --repo "${{ github.repository }}" --yes --cleanup-tag || true

  # ===========================================================================
  # TOOL (native): Must build on each platform
  # ===========================================================================
  create-release-native:
    name: "Create Release"
    needs: detect
    if: needs.detect.outputs.archetype == 'tool' && needs.detect.outputs.affinity == 'native'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Create empty release
        run: |
          gh release delete "${{ needs.detect.outputs.namespace }}-${{ env.TEST_VERSION }}" --repo "${{ github.repository }}" --yes --cleanup-tag || true
          gh release create "${{ needs.detect.outputs.namespace }}-${{ env.TEST_VERSION }}" --repo "${{ github.repository }}" --title "${{ needs.detect.outputs.namespace }}-${{ env.TEST_VERSION }}" --notes "Native build test"

  build-tool-native:
    name: "Build (${{ matrix.os }})"
    needs: [detect, create-release-native]
    if: needs.detect.outputs.archetype == 'tool' && needs.detect.outputs.affinity == 'native'
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Set HOME on Windows
        if: runner.os == 'Windows'
        shell: bash
        run: echo "HOME=$USERPROFILE" >> $GITHUB_ENV

      - name: Build xplat
        shell: bash
        run: |
          if [ "$RUNNER_OS" == "Windows" ]; then
            mkdir -p "$HOME/bin"
            go build -o "$HOME/bin/xplat.exe" ./cmd/xplat
            echo "$HOME/bin" >> $GITHUB_PATH
          else
            mkdir -p "$HOME/.local/bin"
            go build -o "$HOME/.local/bin/xplat" ./cmd/xplat
            echo "$HOME/.local/bin" >> $GITHUB_PATH
          fi

      - name: Run tests
        shell: bash
        run: xplat test ${{ needs.detect.outputs.namespace }}

      - name: Platform build + upload
        shell: bash
        run: |
          RELEASE_VERSION=${{ env.TEST_VERSION }} xplat release build ${{ needs.detect.outputs.namespace }}
          FILES=$(xplat release list ${{ needs.detect.outputs.namespace }} | tr '\n' ' ')
          xplat task tools:gh:release:upload -- "${{ needs.detect.outputs.namespace }}-${{ env.TEST_VERSION }}" $FILES

  verify-tool-native:
    name: "Verify (${{ matrix.os }})"
    needs: [detect, build-tool-native]
    if: needs.detect.outputs.archetype == 'tool' && needs.detect.outputs.affinity == 'native'
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            suffix: linux-amd64
          - os: macos-latest
            suffix: darwin-arm64
          - os: windows-latest
            suffix: windows-amd64.exe
    runs-on: ${{ matrix.os }}
    steps:
      - name: Download and verify
        shell: bash
        run: |
          BINARY="${{ needs.detect.outputs.namespace }}-${{ matrix.suffix }}"
          URL="https://github.com/${{ github.repository }}/releases/download/${{ needs.detect.outputs.namespace }}-${{ env.TEST_VERSION }}/$BINARY"
          echo "Downloading: $URL"
          for i in 1 2 3; do
            curl -sfL "$URL" -o testbin && break
            [ $i -eq 3 ] && echo "ERROR: Failed to download" && exit 1
            sleep 5
          done
          chmod +x testbin 2>/dev/null || true
          ./testbin
          echo "OK: Native binary works!"

  cleanup-tool-native:
    name: "Cleanup"
    needs: [detect, verify-tool-native]
    if: always() && needs.detect.outputs.archetype == 'tool' && needs.detect.outputs.affinity == 'native' && !inputs.skip_cleanup
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Delete test release
        run: gh release delete "${{ needs.detect.outputs.namespace }}-${{ env.TEST_VERSION }}" --repo "${{ github.repository }}" --yes --cleanup-tag || true

  # ===========================================================================
  # EXTERNAL: Install + validate
  # ===========================================================================
  test-external:
    name: "External (${{ matrix.os }})"
    needs: detect
    if: needs.detect.outputs.archetype == 'external'
    strategy:
      fail-fast: false
      matrix:
        os: ${{ inputs.multi_platform && fromJson('["ubuntu-latest", "macos-latest", "windows-latest"]') || fromJson('["ubuntu-latest"]') }}
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Set HOME on Windows
        if: runner.os == 'Windows'
        shell: bash
        run: echo "HOME=$USERPROFILE" >> $GITHUB_ENV

      - name: Build xplat
        shell: bash
        run: |
          if [ "$RUNNER_OS" == "Windows" ]; then
            mkdir -p "$HOME/bin"
            go build -o "$HOME/bin/xplat.exe" ./cmd/xplat
            echo "$HOME/bin" >> $GITHUB_PATH
          else
            mkdir -p "$HOME/.local/bin"
            go build -o "$HOME/.local/bin/xplat" ./cmd/xplat
            echo "$HOME/.local/bin" >> $GITHUB_PATH
          fi
          echo "$HOME/.bun/bin" >> $GITHUB_PATH

      - name: Run tests
        shell: bash
        run: xplat test ${{ needs.detect.outputs.namespace }}

  # ===========================================================================
  # BUILDER / AGGREGATION / BOOTSTRAP / UNKNOWN: Single platform
  # ===========================================================================
  test-other:
    name: "Test (${{ needs.detect.outputs.archetype }})"
    needs: detect
    if: contains(fromJson('["builder", "aggregation", "bootstrap", "unknown"]'), needs.detect.outputs.archetype)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Build xplat
        run: |
          mkdir -p "$HOME/.local/bin"
          go build -o "$HOME/.local/bin/xplat" ./cmd/xplat
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Run tests
        run: xplat test ${{ needs.detect.outputs.namespace }}
