# Test install.sh script
#
# Ensures the install script works on all platforms.
# Runs on release to verify binaries are downloadable.

name: "[Test] Install Script"

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  test-install:
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            name: Linux
          - os: macos-latest
            name: macOS
    runs-on: ${{ matrix.os }}
    name: Test Install (${{ matrix.name }})
    steps:
      - uses: actions/checkout@v4

      - name: Run install.sh
        run: |
          echo "=== Testing install.sh on ${{ matrix.name }} ==="
          sh install.sh

      - name: Verify installation
        run: |
          echo "=== Verifying xplat ==="

          # Add ~/.local/bin to PATH (where install.sh installs)
          export PATH="$HOME/.local/bin:$PATH"

          # Check version
          echo "Testing: xplat version"
          xplat version

          # Check basic commands
          echo "Testing: xplat os which"
          xplat os which sh || xplat os which bash

          echo "Testing: xplat os mkdir"
          xplat os mkdir -p /tmp/xplat-install-test
          [ -d /tmp/xplat-install-test ] || exit 1

          echo "Testing: xplat os rm"
          xplat os rm -rf /tmp/xplat-install-test
          [ ! -d /tmp/xplat-install-test ] || exit 1

          echo "=== All install tests passed ==="

  test-install-windows:
    runs-on: windows-latest
    name: Test Install (Windows)
    steps:
      - uses: actions/checkout@v4

      - name: Run install.sh via Git Bash
        shell: bash
        run: |
          echo "=== Testing install.sh on Windows ==="
          sh install.sh

      - name: Verify installation
        shell: pwsh
        run: |
          Write-Host "=== Verifying xplat ===" -ForegroundColor Cyan

          $xplat = "$env:LOCALAPPDATA\xplat\xplat.exe"

          Write-Host "Testing: xplat version"
          & $xplat version

          Write-Host "Testing: xplat os which"
          & $xplat os which powershell

          Write-Host "Testing: xplat os mkdir"
          & $xplat os mkdir -p "$env:TEMP\xplat-install-test"
          if (-not (Test-Path "$env:TEMP\xplat-install-test")) { exit 1 }

          Write-Host "Testing: xplat os rm"
          & $xplat os rm -rf "$env:TEMP\xplat-install-test"
          if (Test-Path "$env:TEMP\xplat-install-test") { exit 1 }

          Write-Host "=== All install tests passed ===" -ForegroundColor Cyan
