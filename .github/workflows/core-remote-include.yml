# Remote Taskfile Include Test
#
# Validates that external consumers can include Taskfiles from this repo.
# Uses the branch name (head_ref for PRs, ref_name for pushes) since Task's
# remote include requires branch/tag names, not commit SHAs.
#
# This simulates the consumer experience:
# 1. Creates a temp Taskfile outside this repo
# 2. Includes our tools module via git URL
# 3. Bootstraps xplat via download (not build from source)

name: "[Core] Remote Include"

on:
  push:
    branches: [main]
    paths:
      - 'taskfiles/**'
      - '.github/workflows/core-remote-include.yml'
  pull_request:
    paths:
      - 'taskfiles/**'
  workflow_dispatch:

env:
  TASK_X_REMOTE_TASKFILES: '1'

jobs:
  test-remote-include:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Install Task
        uses: arduino/setup-task@v2
        with:
          version: 3.45.5

      - name: Test Remote Tools Include (xplat bootstrap)
        env:
          REPO: ${{ github.repository }}
          # For PRs, use head_ref (branch name); for pushes, use ref_name (branch name)
          # Task's remote include requires a branch/tag name, not a commit SHA
          REF: ${{ github.head_ref || github.ref_name }}
        run: |
          echo "=== Testing Remote Taskfile Include ==="
          echo "Repository: $REPO"
          echo "Ref: $REF"
          echo ""

          # Create consumer-like Taskfile in temp dir (outside this repo)
          mkdir -p /tmp/consumer-test

          # Write Taskfile using printf to avoid heredoc indentation issues
          printf '%s\n' \
            "version: '3'" \
            "" \
            "includes:" \
            "  tools:" \
            "    taskfile: https://github.com/${REPO}.git//taskfiles/Taskfile.tools.yml?ref=${REF}" \
            "" \
            "tasks:" \
            "  test:" \
            "    desc: Test that remote include works" \
            "    cmds:" \
            "      - task tools:xplat:check:deps" \
            "      - xplat version" \
            "      - xplat which task" \
            "      - xplat mkdir -p /tmp/xplat-test/nested" \
            "      - xplat touch /tmp/xplat-test/file.txt" \
            "      - xplat cp /tmp/xplat-test/file.txt /tmp/xplat-test/copy.txt" \
            "      - xplat mv /tmp/xplat-test/copy.txt /tmp/xplat-test/moved.txt" \
            "      - xplat rm -rf /tmp/xplat-test" \
            "      - echo 'SUCCESS - All xplat commands work!'" \
            > /tmp/consumer-test/Taskfile.yml

          echo "=== Consumer Taskfile ==="
          cat /tmp/consumer-test/Taskfile.yml
          echo ""

          echo "=== Running Test ==="
          cd /tmp/consumer-test
          task test --yes

      - name: Test gh taskfile (optional tool)
        env:
          REPO: ${{ github.repository }}
          REF: ${{ github.head_ref || github.ref_name }}
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "=== Testing gh Taskfile (optional) ==="
          cd /tmp/consumer-test

          # Add gh test task
          printf '%s\n' \
            "" \
            "  test-gh:" \
            "    desc: Test gh CLI taskfile" \
            "    cmds:" \
            "      - task tools:gh:check:deps" \
            "      - echo 'SUCCESS - gh taskfile works!'" \
            >> /tmp/consumer-test/Taskfile.yml

          task test-gh --yes

      - name: Verify xplat was downloaded (not built)
        run: |
          echo "=== Verifying Download Path ==="
          # xplat should be in ~/.local/bin from the download
          if [ -f "$HOME/.local/bin/xplat" ]; then
            echo "OK: xplat found in ~/.local/bin (downloaded)"
            $HOME/.local/bin/xplat version
          else
            echo "ERROR: xplat not found in expected location"
            exit 1
          fi
